import Head from 'next/head';
import Image from 'next/image';
import { useEffect, useState, useRef } from 'react';
import { endpoints } from './api/photos';
import Pagination from '@mui/material/Pagination';
import {
  Main,
  Photos,
  Paginate,
  Search 
} from '../styles/index.styles';
import CircularProgress from '@mui/material/CircularProgress';
import { Photo_Details } from '@/constants/photos.constant';


export default function Home() {
  const [photos, setPhotos] = useState<any | null>(null);
  const [searchQuery, setSearchQuery] = useState<any | null>(undefined);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<any | null>(null);
 
  const formQuery = useRef<any>(null);

  const getPhotos = async (page?: number) => { 
    setLoading(true);
    try {
      const data = await endpoints.getCuratedPhotos(page)
      console.log('data', data);
      if (!data) {
        setError('There was a problem loading the photos')
      } else {
        setPhotos(data);
        setSearchQuery(null)
      }

    } catch (e) {
      setError(`error something went wrong, ${e}`)
    } finally {
      setLoading(false);
    }
  }

  const queryPhotos = async (query: string, page?: number) => {
    setLoading(true);
    try {
      const data = await endpoints.getQueryPhotos(query, page)
      if (!data) {
        setError('No Photos found')
      } else {
        setPhotos(data);
      }

    } catch (e) {
      setError(`error something went wrong, ${e}`)
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    const pageNumber = sessionStorage.getItem('page');
    const searchQuery = sessionStorage.getItem('searchQuery') || 'null';
   
    if (searchQuery !== 'null') {
      queryPhotos(searchQuery, Number(pageNumber))
      setSearchQuery(searchQuery);
      formQuery.current[0].value = searchQuery;
    } else {
      if (pageNumber) {
        getPhotos(Number(pageNumber));
      } else {
        getPhotos();
      }
    }
  }, [])
  
  // @ts-ignore
  const changePage = ((event, page: number) => {
    if (!searchQuery) {
      getPhotos(page)
    } else {
      queryPhotos(searchQuery, page);
    }
    window.scrollTo(0, 0);

  })

  // @ts-ignore
  const querySearch = ((query) => {
    query.preventDefault();
    const searchText = query?.target[0].value
    setSearchQuery(searchText)
    queryPhotos(searchText)
  })

  const goHome = (page: number) => {
    if (formQuery.current) {
      formQuery.current[0].value = '';
    }
    getPhotos(page);
  }

  useEffect(() => {
    sessionStorage.setItem('page', photos?.page);
    sessionStorage.setItem('searchQuery', searchQuery);
  }, [photos, searchQuery]);

  return (
    <>
      <Head>
        <title>Photo Search</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Main data-testid='home'>

        <div className='header'>
          <button className='home' onClick={() => goHome(1)}>Home</button>
          <Search data-testid='search'>
            <div className='search-container'>
              <form ref={formQuery} onSubmit={querySearch}>
                <input 
                  className='search-bar' 
                  type="text" 
                  placeholder='Search...'
                  name="search" >
                </input>
                <button className='search-button'>
                  <span className="ico ico-mglass"></span>
                </button>
              </form>
                
            </div>
          </Search>
        </div>

        {error && <div>{error}</div>}

        {loading && <div className="loading">
          <CircularProgress size={100}/>
        </div>}
        
        <Photos>
          {photos?.photos?.map((photo: Photo_Details ) => {
            return ( 
              <div className="photo_container" key={photo.id}>
                <Image 
                  src={photo.src.large}
                  alt={photo.alt}
                  width={photo.width / 10}
                  height={photo.height / 10}
                  />
                  <div className='info'>
                    {photo.photographer &&
                      <p>{photo.photographer}</p>
                    }
                    {photo.url && 
                      <a href={photo.url} target="_blank">Link</a>
                    }
                  </div>
              </div>
            )
          })}
        </Photos>

        {photos && 
          <Paginate>
            <Pagination
              count={Math.floor(photos.total_results / photos.per_page)}
              page={photos.page}
              siblingCount={3}
              onChange={changePage}
              size="large"
              className="resize"
            />
          </Paginate>
        }     
      </Main>
    </>
  )
}
